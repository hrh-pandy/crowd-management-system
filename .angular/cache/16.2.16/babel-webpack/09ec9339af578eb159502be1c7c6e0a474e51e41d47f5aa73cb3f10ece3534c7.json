{"ast":null,"code":"import { Chart } from 'chart.js/auto';\nimport { getDayRangeUtc } from '../../core/services/utils/date-utils';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../../core/services/dashboard.service\";\nimport * as i2 from \"../../core/services/site.service\";\nimport * as i3 from \"../../core/services/analytics-context.service\";\nimport * as i4 from \"@angular/common\";\nimport * as i5 from \"@angular/forms\";\nconst _c0 = [\"occupancyChart\"];\nconst _c1 = [\"demographicsChart\"];\nconst _c2 = [\"footfallChart\"];\nfunction DashboardComponent_option_14_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"option\", 21);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const site_r4 = ctx.$implicit;\n    i0.ɵɵproperty(\"ngValue\", site_r4);\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate2(\" \", site_r4.name, \" \\u2022 \", site_r4.timezone, \" \");\n  }\n}\nexport let DashboardComponent = /*#__PURE__*/(() => {\n  class DashboardComponent {\n    constructor(dashboardService, siteService, analyticsContext) {\n      this.dashboardService = dashboardService;\n      this.siteService = siteService;\n      this.analyticsContext = analyticsContext;\n      /* ================= KPIs ================= */\n      this.liveOccupancy = 0;\n      this.footfall = 0;\n      this.avgDwellTime = '';\n      /* ================= SITES ================= */\n      this.sites = [];\n      this.selectedDay = 'today';\n    }\n    /* ================= INIT ================= */\n    ngOnInit() {\n      this.loadSites();\n    }\n    ngOnDestroy() {\n      this.occupancyChart?.destroy();\n      this.demographicsChart?.destroy();\n      this.footfallChart?.destroy();\n    }\n    /* ================= LOAD SITES ================= */\n    loadSites() {\n      this.siteService.getSites().subscribe({\n        next: res => {\n          this.sites = res.sites || res || [];\n          if (this.sites.length) {\n            this.onSiteChange(this.sites[0]);\n          }\n        },\n        error: err => console.error('Sites error:', err)\n      });\n    }\n    /* ================= SITE CHANGE ================= */\n    onSiteChange(site) {\n      this.selectedSite = site;\n      const {\n        fromUtc,\n        toUtc\n      } = getDayRangeUtc(site.timezone, this.selectedDay);\n      this.analyticsContext.setContext({\n        siteId: site.siteId,\n        timezone: site.timezone,\n        fromUtc,\n        toUtc\n      });\n      this.loadKPIs();\n      this.loadOccupancyTimeline();\n      this.loadDemographics();\n      this.loadFootfallByHour();\n    }\n    /* ================= KPIs ================= */\n    loadKPIs() {\n      this.dashboardService.getFootfall().subscribe(res => {\n        this.footfall = res.footfall ?? 0;\n      });\n      this.dashboardService.getDwellTime().subscribe(res => {\n        const mins = Math.floor(res.avgDwellMinutes || 0);\n        const secs = Math.round(((res.avgDwellMinutes || 0) - mins) * 60);\n        this.avgDwellTime = `${mins} min ${secs} sec`;\n      });\n    }\n    /* ================= OCCUPANCY TIMELINE ================= */\n    loadOccupancyTimeline() {\n      this.dashboardService.getOccupancyTimeline().subscribe(res => {\n        if (!res?.buckets?.length) return;\n        const labels = [];\n        const values = [];\n        res.buckets.forEach(b => {\n          labels.push(b.local.split(' ')[1].slice(0, 5));\n          values.push(b.avg > 0 ? Math.round(b.avg) : null);\n        });\n        this.liveOccupancy = [...values].reverse().find(v => v !== null) ?? 0;\n        this.renderOccupancyChart(labels, values);\n      });\n    }\n    renderOccupancyChart(labels, values) {\n      this.occupancyChart?.destroy();\n      this.occupancyChart = new Chart(this.occupancyCanvas.nativeElement, {\n        type: 'line',\n        data: {\n          labels,\n          datasets: [{\n            data: values,\n            borderColor: '#0d9488',\n            borderWidth: 2,\n            fill: false,\n            tension: 0.35,\n            spanGaps: true,\n            pointRadius: 2\n          }]\n        },\n        options: {\n          responsive: true,\n          maintainAspectRatio: false,\n          plugins: {\n            legend: {\n              display: false\n            }\n          },\n          scales: {\n            x: {\n              grid: {\n                display: false\n              }\n            },\n            y: {\n              beginAtZero: false,\n              suggestedMin: 80,\n              suggestedMax: 150\n            }\n          }\n        }\n      });\n    }\n    /* ================= DEMOGRAPHICS (PIE) ================= */\n    loadDemographics() {\n      this.dashboardService.getDemographics().subscribe(res => {\n        if (!res) return;\n        const labels = Object.keys(res);\n        const values = Object.values(res);\n        this.demographicsChart?.destroy();\n        this.demographicsChart = new Chart(this.demographicsCanvas.nativeElement, {\n          type: 'pie',\n          data: {\n            labels,\n            datasets: [{\n              data: values,\n              backgroundColor: ['#0d9488', '#38bdf8', '#fbbf24', '#fb7185']\n            }]\n          },\n          options: {\n            responsive: true,\n            plugins: {\n              legend: {\n                position: 'bottom'\n              }\n            }\n          }\n        });\n      });\n    }\n    /* ================= FOOTFALL BY HOUR (BAR) ================= */\n    loadFootfallByHour() {\n      this.dashboardService.getFootfall().subscribe(res => {\n        if (!res?.buckets?.length) return;\n        const labels = [];\n        const values = [];\n        res.buckets.forEach(b => {\n          labels.push(b.local.split(' ')[1].slice(0, 5));\n          values.push(b.count);\n        });\n        this.footfallChart?.destroy();\n        this.footfallChart = new Chart(this.footfallCanvas.nativeElement, {\n          type: 'bar',\n          data: {\n            labels,\n            datasets: [{\n              data: values,\n              backgroundColor: '#38bdf8',\n              borderRadius: 4\n            }]\n          },\n          options: {\n            responsive: true,\n            plugins: {\n              legend: {\n                display: false\n              }\n            },\n            scales: {\n              x: {\n                grid: {\n                  display: false\n                }\n              },\n              y: {\n                beginAtZero: true\n              }\n            }\n          }\n        });\n      });\n    }\n    static {\n      this.ɵfac = function DashboardComponent_Factory(t) {\n        return new (t || DashboardComponent)(i0.ɵɵdirectiveInject(i1.DashboardService), i0.ɵɵdirectiveInject(i2.SiteService), i0.ɵɵdirectiveInject(i3.AnalyticsContextService));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: DashboardComponent,\n        selectors: [[\"app-dashboard\"]],\n        viewQuery: function DashboardComponent_Query(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵviewQuery(_c0, 7);\n            i0.ɵɵviewQuery(_c1, 7);\n            i0.ɵɵviewQuery(_c2, 7);\n          }\n          if (rf & 2) {\n            let _t;\n            i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.occupancyCanvas = _t.first);\n            i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.demographicsCanvas = _t.first);\n            i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.footfallCanvas = _t.first);\n          }\n        },\n        decls: 62,\n        vars: 5,\n        consts: [[1, \"dashboard-layout\"], [1, \"sidebar\"], [1, \"logo\"], [1, \"active\"], [1, \"main\"], [1, \"topbar\"], [3, \"ngModel\", \"ngModelChange\", \"change\"], [3, \"ngValue\", 4, \"ngFor\", \"ngForOf\"], [1, \"overview\"], [1, \"cards\"], [1, \"card\"], [1, \"up\"], [1, \"down\"], [2, \"height\", \"300px\"], [\"id\", \"occupancyChart\"], [1, \"chart-card\"], [1, \"chart-container\"], [\"occupancyChart\", \"\"], [1, \"chart-row\"], [\"demographicsChart\", \"\"], [\"footfallChart\", \"\"], [3, \"ngValue\"]],\n        template: function DashboardComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵelementStart(0, \"div\", 0)(1, \"aside\", 1)(2, \"div\", 2);\n            i0.ɵɵtext(3, \"kloudspot\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(4, \"nav\")(5, \"a\", 3);\n            i0.ɵɵtext(6, \"Overview\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(7, \"a\");\n            i0.ɵɵtext(8, \" Crowd Entries\");\n            i0.ɵɵelementEnd()()();\n            i0.ɵɵelementStart(9, \"main\", 4)(10, \"header\", 5)(11, \"h2\");\n            i0.ɵɵtext(12, \"Crowd Solutions\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(13, \"select\", 6);\n            i0.ɵɵlistener(\"ngModelChange\", function DashboardComponent_Template_select_ngModelChange_13_listener($event) {\n              return ctx.selectedSite = $event;\n            })(\"change\", function DashboardComponent_Template_select_change_13_listener() {\n              return ctx.onSiteChange(ctx.selectedSite);\n            });\n            i0.ɵɵtemplate(14, DashboardComponent_option_14_Template, 2, 3, \"option\", 7);\n            i0.ɵɵelementEnd()();\n            i0.ɵɵelementStart(15, \"section\", 8)(16, \"h3\");\n            i0.ɵɵtext(17, \"Overview\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(18, \"div\", 9)(19, \"div\", 10)(20, \"p\");\n            i0.ɵɵtext(21, \"Live Occupancy\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(22, \"h2\");\n            i0.ɵɵtext(23);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(24, \"span\", 11);\n            i0.ɵɵtext(25, \"\\u2191 10% more than yesterday\");\n            i0.ɵɵelementEnd()();\n            i0.ɵɵelementStart(26, \"div\", 10)(27, \"p\");\n            i0.ɵɵtext(28, \"Today's Footfall\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(29, \"h2\");\n            i0.ɵɵtext(30);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(31, \"span\", 12);\n            i0.ɵɵtext(32, \"\\u2193 10% less than yesterday\");\n            i0.ɵɵelementEnd()();\n            i0.ɵɵelementStart(33, \"div\", 10)(34, \"p\");\n            i0.ɵɵtext(35, \"Avg Dwell Time\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(36, \"h2\");\n            i0.ɵɵtext(37);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(38, \"span\", 11);\n            i0.ɵɵtext(39, \"\\u2191 6% more than yesterday\");\n            i0.ɵɵelementEnd()()();\n            i0.ɵɵelementStart(40, \"div\", 13);\n            i0.ɵɵelement(41, \"canvas\", 14);\n            i0.ɵɵelementEnd()();\n            i0.ɵɵelementStart(42, \"section\", 8)(43, \"div\", 15)(44, \"h4\");\n            i0.ɵɵtext(45, \"Occupancy Timeline\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(46, \"div\", 16);\n            i0.ɵɵelement(47, \"canvas\", null, 17);\n            i0.ɵɵelementEnd()();\n            i0.ɵɵelementStart(49, \"div\", 18)(50, \"div\", 15)(51, \"h4\");\n            i0.ɵɵtext(52, \"Demographics\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(53, \"div\", 16);\n            i0.ɵɵelement(54, \"canvas\", null, 19);\n            i0.ɵɵelementEnd()();\n            i0.ɵɵelementStart(56, \"div\", 15)(57, \"h4\");\n            i0.ɵɵtext(58, \"Footfall by Hour\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(59, \"div\", 16);\n            i0.ɵɵelement(60, \"canvas\", null, 20);\n            i0.ɵɵelementEnd()()()()()();\n          }\n          if (rf & 2) {\n            i0.ɵɵadvance(13);\n            i0.ɵɵproperty(\"ngModel\", ctx.selectedSite);\n            i0.ɵɵadvance(1);\n            i0.ɵɵproperty(\"ngForOf\", ctx.sites);\n            i0.ɵɵadvance(9);\n            i0.ɵɵtextInterpolate(ctx.liveOccupancy);\n            i0.ɵɵadvance(7);\n            i0.ɵɵtextInterpolate(ctx.footfall);\n            i0.ɵɵadvance(7);\n            i0.ɵɵtextInterpolate(ctx.avgDwellTime);\n          }\n        },\n        dependencies: [i4.NgForOf, i5.NgSelectOption, i5.ɵNgSelectMultipleOption, i5.SelectControlValueAccessor, i5.NgControlStatus, i5.NgModel],\n        styles: [\".dashboard-layout[_ngcontent-%COMP%]{display:flex;height:100vh}.sidebar[_ngcontent-%COMP%]{width:240px;background:linear-gradient(180deg,#0f766e,#064e3b);color:#fff;padding:20px}.sidebar[_ngcontent-%COMP%]   .logo[_ngcontent-%COMP%]{font-weight:700;margin-bottom:30px}.sidebar[_ngcontent-%COMP%]   nav[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{display:block;padding:12px;border-radius:6px;margin-bottom:10px;cursor:pointer}.sidebar[_ngcontent-%COMP%]   nav[_ngcontent-%COMP%]   a.active[_ngcontent-%COMP%]{background:rgba(255,255,255,.2)}.main[_ngcontent-%COMP%]{flex:1;background:#f5f7fb;padding:20px}.topbar[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.cards[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-top:20px}.card[_ngcontent-%COMP%]{background:#fff;padding:20px;border-radius:10px}.card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:10px 0}.up[_ngcontent-%COMP%]{color:green;font-size:12px}.down[_ngcontent-%COMP%]{color:red;font-size:12px}.chart-card[_ngcontent-%COMP%]{margin-top:25px;background:#fff;padding:20px;border-radius:10px}\"]\n      });\n    }\n  }\n  return DashboardComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}